generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") // Solo para migraciones locales
}

model Usuario {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  nombre              String
  telefono            String?
  rol                 String               @default("ALUMNO")
  imagen              String?
  activo              Boolean              @default(true)
  debeCambiarPassword Boolean              @default(true)
  creadoEn            DateTime             @default(now())
  actualizadoEn       DateTime             @updatedAt
  alumnos             Alumno[]
  clasesDocente       Clase[]              @relation("DocenteClases")
  notificaciones      Notificacion[]
  passwordResetTokens PasswordResetToken[]

  @@map("usuarios")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  usuarioId String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}


model Alumno {
  id                        String           @id @default(cuid())
  usuarioId                 String
  nombre                    String?
  apellido                  String?
  dni                       String?
  fechaNacimiento           DateTime?
  edad                      Int?
  domicilio                 String?
  domicilioCalle            String?
  domicilioNumero           String?
  domicilioTira             String?
  domicilioPiso             String?
  domicilioDepto            String?
  colegio                   String?
  grado                     String?
  tutorNombre               String?
  tutorApellido             String?
  tutorDni                  String?
  tutorRelacion             String?
  tutorDomicilio            String?
  tutorDomicilioCalle       String?
  tutorDomicilioNumero      String?
  tutorDomicilioTira        String?
  tutorDomicilioPiso        String?
  tutorDomicilioDepto       String?
  tutorTelefonoPrincipal    String?
  tutorTelefonoAlternativo  String?
  tutorEmail                String?
  tutorProfesion            String?
  emergenciaNombre          String?
  emergenciaTelefono        String?
  emergenciaRelacion        String?
  obraSocial                String?
  numeroAfiliado            String?
  hospitalReferencia        String?
  alergias                  String?
  medicacionHabitual        String?
  condicionesMedicas        String?
  restriccionesFisicas      String?
  autorizacionParticipacion Boolean          @default(false)
  autorizacionMedica        Boolean          @default(false)
  autorizacionRetiro        String?
  autorizacionImagenes      Boolean          @default(false)
  aceptacionReglamento      Boolean          @default(false)
  firmaResponsable          String?
  aclaracionFirma           String?
  dniFirma                  String?
  planPago                  String?
  formaPago                 String?
  firmaConformidad          String?
  perfilCompleto            Boolean          @default(false)
  contactoEmergencia        String?
  telefonoEmergencia        String?
  nivel                     String           @default("PRINCIPIANTE")
  notas                     String?
  claseUnicaAprobada       Boolean          @default(false)
  creadoEn                  DateTime         @default(now())
  actualizadoEn             DateTime         @updatedAt
  usuario                   Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  asistencias               Asistencia[]
  citasNivelacion           CitaNivelacion[]
  inscripciones             Inscripcion[]
  obras                     Obra[]
  pagos                     Pago[]
  solicitudesRecuperacion   SolicitudRecuperacion[]
  creditosClaseExtra        CreditoClaseExtra[]

  @@map("alumnos")
}

model Taller {
  id            String        @id @default(cuid())
  nombre        String        @unique
  descripcion   String?
  imagen        String?
  cupoMaximo    Int           @default(10)
  precio        Float         @default(0)  // Precio base o clase suelta
  precio1dia    Float         @default(0)  // Precio mensual 1 vez por semana
  precio2dia    Float         @default(0)  // Precio mensual 2 veces por semana
  precio1diaExt Float?        @default(0)  // Precio extendido (merienda) 1 v/s
  precio2diaExt Float?        @default(0)  // Precio extendido (merienda) 2 v/s
  tipo          String        @default("REGULAR") // REGULAR o VERANO
  duracion      Int           @default(90)
  activo        Boolean       @default(true)
  diasSemana    String?
  horaInicio    String?
  horarios      Json?         // [{ label: "16:00 a 17:20", value: "16:00-17:20" }]
  creadoEn      DateTime      @default(now())
  actualizadoEn DateTime      @updatedAt
  clases              Clase[]
  inscripciones       Inscripcion[]
  creditosClaseExtra  CreditoClaseExtra[]

  @@map("talleres")
}

model Clase {
  id              String       @id @default(cuid())
  tallerId        String
  docenteId       String
  fechaHora       DateTime
  duracionMinutos Int          @default(90)
  ubicacion       String?
  estado          String       @default("PROGRAMADA")
  notas           String?
  creadoEn        DateTime     @default(now())
  actualizadoEn   DateTime     @updatedAt
  asistencias     Asistencia[]
  docente         Usuario      @relation("DocenteClases", fields: [docenteId], references: [id])
  taller          Taller       @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  obras           Obra[]

  @@map("clases")
}

model CitaNivelacion {
  id            String   @id @default(cuid())
  alumnoId      String
  fecha         DateTime
  estado        String   @default("PENDIENTE")
  notas         String?
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  alumno        Alumno   @relation(fields: [alumnoId], references: [id], onDelete: Cascade)

  @@map("citas_nivelacion")
}

model Inscripcion {
  id               String   @id @default(cuid())
  alumnoId         String
  tallerId         String
  dia              String?
  horario          String?
  pagado           Boolean  @default(false)
  fechaInscripcion DateTime @default(now())
  estado           String   @default("ACTIVA")
  notas            String?
  fase             String?
  asiento          String?
  creadoEn         DateTime @default(now())
  actualizadoEn    DateTime @updatedAt
  taller           Taller   @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  alumno           Alumno   @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  pagos            Pago[]
  solicitudesRecuperacion   SolicitudRecuperacion[]

  @@map("inscripciones")
}

model Asistencia {
  id       String   @id @default(cuid())
  alumnoId String
  claseId  String
  estado   String   @default("PRESENTE")
  notas    String?
  creadoEn DateTime @default(now())
  clase    Clase    @relation(fields: [claseId], references: [id], onDelete: Cascade)
  alumno   Alumno   @relation(fields: [alumnoId], references: [id], onDelete: Cascade)

  @@unique([alumnoId, claseId])
  @@map("asistencias")
}

model Pago {
  id             String      @id @default(cuid())
  alumnoId       String
  inscripcionId  String
  monto          Float
  fechaPago      DateTime    @default(now())
  estado         String      @default("PENDIENTE")
  mercadoPagoId  String?
  comprobantePdf String?
  mesCubierto    Int
  anioCubierto   Int
  concepto       String?
  esPagoParcial  Boolean     @default(false)
  totalOriginal  Float?      // El monto total si se dividi贸 en partes
  
  // Datos de Facturaci贸n AFIP
  cae            String?     // C贸digo de Autorizaci贸n Electr贸nico
  caeVencimiento DateTime?   // Fecha de vencimiento del CAE
  puntoVenta     Int?        // Punto de venta (ej: 1, 2...)
  nroComprobante Int?        // N煤mero correlativo de factura
  tipoFactura    String?     // 'B' para monotributista a consumidor final
  cuitEmisor     String?     // El CUIT con el que se emiti贸
  emisorNombre   String?     // Para mayor claridad
  facturadoEn    DateTime?   // Fecha de autorizaci贸n ante AFIP

  creadoEn       DateTime    @default(now())
  actualizadoEn  DateTime    @updatedAt
  inscripcion    Inscripcion @relation(fields: [inscripcionId], references: [id], onDelete: Cascade)
  alumno         Alumno      @relation(fields: [alumnoId], references: [id], onDelete: Cascade)

  @@map("pagos")
}

model Obra {
  id            String   @id @default(cuid())
  alumnoId      String
  claseId       String?
  imagenUrl     String
  titulo        String?
  descripcion   String?
  tecnica       String?
  fechaCreacion DateTime @default(now())
  destacada     Boolean  @default(false)
  creadoEn      DateTime @default(now())
  clase         Clase?   @relation(fields: [claseId], references: [id])
  alumno        Alumno   @relation(fields: [alumnoId], references: [id], onDelete: Cascade)

  @@map("obras")
}

model Notificacion {
  id         String   @id @default(cuid())
  usuarioId  String
  titulo     String
  mensaje    String
  leida      Boolean  @default(false)
  tipo       String?
  enlace     String?
  fechaEnvio DateTime @default(now())
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}

model Testimonio {
  id        String   @id @default(cuid())
  nombre    String
  texto     String
  imagen    String?
  destacado Boolean  @default(false)
  activo    Boolean  @default(true)
  creadoEn  DateTime @default(now())

  @@map("testimonios")
}

model Configuracion {
  id          String  @id @default(cuid())
  clave       String  @unique
  valor       String
  descripcion String?

  @@map("configuracion")
}

model Tarea {
  id            String    @id @default(cuid())
  titulo        String
  descripcion   String?
  fecha         DateTime
  hora          String?   // Hora opcional (ej: "09:00")
  prioridad     String    @default("MEDIA") // BAJA, MEDIA, ALTA
  categoria     String?   // TALLER, ALUMNO, COMPRAS, CONTACTO, OTRO
  completada    Boolean   @default(false)
  completadaEn  DateTime?
  creadoEn      DateTime  @default(now())
  actualizadoEn DateTime  @updatedAt

  @@map("tareas")
}

model SliderImage {
  id          String   @id @default(cuid())
  imagenUrl   String
  titulo      String?
  descripcion String?
  enlace      String?
  orden       Int      @default(0)
  activo      Boolean  @default(true)
  creadoEn    DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@map("slider_images")
}

// ==================== TIENDA / E-COMMERCE ====================

model Producto {
  id            String          @id @default(cuid())
  nombre        String
  descripcion   String?
  precio        Float
  imagenUrl     String?
  imagenes      String?         // JSON array de URLs adicionales
  categoria     String          @default("OBRA") // "OBRA" | "MATERIAL"
  stock         Int             @default(1)
  activo        Boolean         @default(true)
  destacado     Boolean         @default(false)
  tecnica       String?         // Para obras: "leo", "Acuarela", etc.
  dimensiones   String?         // "30x40 cm"
  artista       String?         @default("Natalia Fusari")
  creadoEn      DateTime        @default(now())
  actualizadoEn DateTime        @updatedAt
  ordenes       OrdenProducto[]

  @@map("productos")
}

model OrdenTienda {
  id              String          @id @default(cuid())
  nombreCliente   String
  emailCliente    String
  telefonoCliente String
  direccion       String?
  total           Float
  estado          String          @default("PENDIENTE") // PENDIENTE, CONFIRMADA, ENVIADA, ENTREGADA, CANCELADA
  notas           String?
  creadoEn        DateTime        @default(now())
  actualizadoEn   DateTime        @updatedAt
  productos       OrdenProducto[]

  @@map("ordenes_tienda")
}

model OrdenProducto {
  id          String      @id @default(cuid())
  ordenId     String
  productoId  String
  cantidad    Int         @default(1)
  precioUnit  Float
  orden       OrdenTienda @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  producto    Producto    @relation(fields: [productoId], references: [id])

  @@map("orden_productos")
}

// Slides del Hero principal - completamente administrables
model Slide {
  id            String   @id @default(cuid())
  titulo        String   // T铆tulo principal grande
  subtitulo     String?  // Subt铆tulo (ej: "Limon茅 | Edici贸n 2026")
  descripcion   String?  // Descripci贸n/tagline
  tags          String?  // JSON array de tags/badges (ej: [" 6 Ene", " 5-12 a帽os"])
  badgeTexto    String?  // Badge superior opcional (ej: "隆Prob谩 sin costo!")
  textoBoton    String?  // Texto del bot贸n CTA
  enlace        String?  // URL del bot贸n
  imagenUrl     String   // Imagen de fondo
  estiloOverlay String   @default("light") // "light" o "dark" para determinar colores
  colorTitulo    String   @default("#2D2D2D")
  colorSubtitulo String   @default("#8E44AD")
  colorDescripcion String @default("#57534E")
  colorBadge     String   @default("#FFFFFF")
  colorBoton     String   @default("#2D2D2D")
  colorFondoBoton String  @default("#F1C40F")
  orden         Int      @default(0)
  activo        Boolean  @default(true)
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@map("slides")
}

// Opciones de inscripci贸n administrables
model OpcionInscripcion {
  id            String   @id @default(cuid())
  nombre        String   @unique
  descripcion   String?
  emoji         String   @default("")
  colorFondo    String   @default("bg-emerald-100") // Tailwind class for icon bg
  colorBorde    String   @default("border-lemon-400") // Tailwind class for hover border
  colorHoverBg  String   @default("bg-lemon-50/50") // Tailwind class for hover bg
  tipo          String   @default("regular") // "regular" | "verano" | "clase-unica" | "custom"
  redirigirUrl  String?  // If set, redirects to this URL instead of the normal flow
  esNuevo       Boolean  @default(false)
  orden         Int      @default(0)
  activo        Boolean  @default(true)
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@map("opciones_inscripcion")
}

model SolicitudRecuperacion {
  id                  String   @id @default(cuid())
  alumnoId            String
  inscripcionId       String
  fechaClaseOriginal  DateTime
  motivo              String?
  estado              String   @default("PENDIENTE") // PENDIENTE, APROBADA, RECHAZADA
  
  // Si es aprobada:
  esRecuperable      Boolean  @default(false)
  fechaRecuperacion   DateTime?
  horarioRecuperacion String? // El bloque horario
  
  creadoEn            DateTime @default(now())
  actualizadoEn       DateTime @updatedAt
  
  alumno              Alumno      @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  inscripcion         Inscripcion @relation(fields: [inscripcionId], references: [id], onDelete: Cascade)

  @@map("solicitudes_recuperacion")
}

model DiaNoLaborable {
  id          String   @id @default(cuid())
  fecha       DateTime @unique
  motivo      String?
  creadoEn    DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@map("dias_no_laborables")
}

model CreditoClaseExtra {
  id                String    @id @default(cuid())
  alumnoId          String
  tallerId          String?   // Taller afectado
  motivo            String?   // E.g. "D铆a no laborable: Feriado"
  usado             Boolean   @default(false)
  fechaProgramada   DateTime?
  horarioProgramado String?
  creadoEn          DateTime  @default(now())
  actualizadoEn     DateTime  @updatedAt

  alumno            Alumno    @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  taller            Taller?   @relation(fields: [tallerId], references: [id], onDelete: SetNull)

  @@map("creditos_clase_extra")
}

model Visita {
  id        String   @id @default(cuid())
  fecha     DateTime @default(now())
  referente String?  // "direct", "google", "facebook", "instagram", "other"
  path      String?
  userAgent String?
  ipSession String?  // Hash or simple ID to group visits

  @@index([fecha])
  @@map("visitas")
}
