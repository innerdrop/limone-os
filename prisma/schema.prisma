// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==================== MODELS ====================
// Note: SQLite doesn't support enums, so we use String with comments for valid values

model Usuario {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  nombre        String
  telefono      String?
  rol           String    @default("ALUMNO") // ALUMNO, ADMIN, DOCENTE
  imagen        String?
  activo              Boolean   @default(true)
  debeCambiarPassword Boolean   @default(true)
  creadoEn            DateTime  @default(now())
  actualizadoEn       DateTime  @updatedAt

  // Relaciones
  alumno         Alumno?
  clasesDocente  Clase[]        @relation("DocenteClases")
  notificaciones Notificacion[]

  @@map("usuarios")
}

model Alumno {
  id                 String   @id @default(cuid())
  usuarioId          String   @unique
  
  // Datos del alumno
  dni                String?
  fechaNacimiento    DateTime?
  edad               Int?
  domicilio          String?
  
  // Datos del padre/madre/tutor legal
  tutorNombre                String?
  tutorDni                   String?
  tutorRelacion              String? // "Padre", "Madre", "Tutor"
  tutorDomicilio             String?
  tutorTelefonoPrincipal     String?
  tutorTelefonoAlternativo   String?
  tutorEmail                 String?
  tutorProfesion             String?
  
  // Contacto de emergencia
  emergenciaNombre           String?
  emergenciaTelefono         String?
  emergenciaRelacion         String?
  
  // Información de salud
  obraSocial                 String?
  numeroAfiliado             String?
  hospitalReferencia         String?
  alergias                   String?
  medicacionHabitual         String?
  condicionesMedicas         String?
  restriccionesFisicas       String?
  
  // Autorizaciones
  autorizacionParticipacion  Boolean  @default(false)
  autorizacionMedica         Boolean  @default(false)
  autorizacionRetiro         String?  // JSON con personas autorizadas
  autorizacionImagenes       Boolean  @default(false)
  aceptacionReglamento       Boolean  @default(false)
  firmaResponsable           String?  // Base64 de la firma
  aclaracionFirma            String?
  dniFirma                   String?
  
  // Información administrativa
  planPago                   String?
  formaPago                  String?
  firmaConformidad           String?  // Base64 de la firma
  
  // Control de perfil
  perfilCompleto             Boolean  @default(false)
  
  // Campos legacy
  contactoEmergencia String?
  telefonoEmergencia String?
  nivel              String   @default("PRINCIPIANTE") // PRINCIPIANTE, INTERMEDIO, AVANZADO
  notas              String?
  creadoEn           DateTime @default(now())
  actualizadoEn      DateTime @updatedAt

  // Relaciones
  usuario       Usuario       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  inscripciones Inscripcion[]
  asistencias   Asistencia[]
  pagos         Pago[]
  obras         Obra[]

  @@map("alumnos")
}

model Taller {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  imagen      String?
  cupoMaximo  Int      @default(10)
  precio      Float    @default(0)
  duracion    Int      @default(90) // minutos
  activo      Boolean  @default(true)
  diasSemana  String?  // "LUNES,MIERCOLES"
  horaInicio  String?  // "18:00"
  creadoEn    DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  // Relaciones
  clases        Clase[]
  inscripciones Inscripcion[]

  @@map("talleres")
}

model Clase {
  id              String   @id @default(cuid())
  tallerId        String
  docenteId       String
  fechaHora       DateTime
  duracionMinutos Int      @default(90)
  ubicacion       String?
  estado          String   @default("PROGRAMADA") // PROGRAMADA, COMPLETADA, CANCELADA
  notas           String?
  creadoEn        DateTime @default(now())
  actualizadoEn   DateTime @updatedAt

  // Relaciones
  taller      Taller       @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  docente     Usuario      @relation("DocenteClases", fields: [docenteId], references: [id])
  asistencias Asistencia[]
  obras       Obra[]

  @@map("clases")
}

model Inscripcion {
  id               String   @id @default(cuid())
  alumnoId         String
  tallerId         String
  dia              String?  // "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"
  horario          String?  // "09:00-11:00", "14:00-16:00", "18:00-20:00"
  pagado           Boolean  @default(false)
  fechaInscripcion DateTime @default(now())
  estado           String   @default("ACTIVA") // ACTIVA, PAUSADA, FINALIZADA
  notas            String?
  fase             String?  // "Fase 1", "Fase 2", "Fase 3"
  asiento          Int?     // 1 a 10
  creadoEn         DateTime @default(now())
  actualizadoEn    DateTime @updatedAt

  // Relaciones
  alumno Alumno @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  taller Taller @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  pagos  Pago[]

  @@map("inscripciones")
}


model Asistencia {
  id        String   @id @default(cuid())
  alumnoId  String
  claseId   String
  estado    String   @default("PRESENTE") // PRESENTE, AUSENTE, AVISADO, JUSTIFICADO
  notas     String?
  creadoEn  DateTime @default(now())

  // Relaciones
  alumno Alumno @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  clase  Clase  @relation(fields: [claseId], references: [id], onDelete: Cascade)

  @@unique([alumnoId, claseId])
  @@map("asistencias")
}

model Pago {
  id             String   @id @default(cuid())
  alumnoId       String
  inscripcionId  String
  monto          Float
  fechaPago      DateTime @default(now())
  estado         String   @default("PENDIENTE") // PENDIENTE, APROBADO, RECHAZADO
  mercadoPagoId  String?
  comprobantePdf String?
  mesCubierto    Int      // 1-12
  anioCubierto   Int      // 2024, 2025...
  concepto       String?
  creadoEn       DateTime @default(now())
  actualizadoEn  DateTime @updatedAt

  // Relaciones
  alumno      Alumno      @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  inscripcion Inscripcion @relation(fields: [inscripcionId], references: [id], onDelete: Cascade)

  @@map("pagos")
}

model Obra {
  id            String   @id @default(cuid())
  alumnoId      String
  claseId       String?
  imagenUrl     String
  titulo        String?
  descripcion   String?
  tecnica       String?
  fechaCreacion DateTime @default(now())
  destacada     Boolean  @default(false)
  creadoEn      DateTime @default(now())

  // Relaciones
  alumno Alumno @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  clase  Clase? @relation(fields: [claseId], references: [id])

  @@map("obras")
}

model Notificacion {
  id         String   @id @default(cuid())
  usuarioId  String
  titulo     String
  mensaje    String
  leida      Boolean  @default(false)
  tipo       String?  // "RECORDATORIO", "PAGO", "SISTEMA"
  enlace     String?
  fechaEnvio DateTime @default(now())

  // Relaciones
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}

model Testimonio {
  id        String   @id @default(cuid())
  nombre    String
  texto     String
  imagen    String?
  destacado Boolean  @default(false)
  activo    Boolean  @default(true)
  creadoEn  DateTime @default(now())

  @@map("testimonios")
}

model Configuracion {
  id          String  @id @default(cuid())
  clave       String  @unique
  valor       String
  descripcion String?

  @@map("configuracion")
}
