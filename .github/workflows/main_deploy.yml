# ============================================================
# ðŸš€ Limone OS - CI/CD Pipeline
# V Solutions | Deploy automÃ¡tico al VPS
# ============================================================

name: Deploy to VPS

on:
  push:
    branches:
      - main
  # Permite ejecuciÃ³n manual desde GitHub
  workflow_dispatch:

env:
  PROJECT_PATH: /var/www/limone

jobs:
  # ============================================
  # Job: Deploy to Production VPS
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      # ------------------------------------------
      # 1. Checkout del cÃ³digo
      # ------------------------------------------
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------
      # 2. Configurar SSH
      # ------------------------------------------
      - name: ðŸ” Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

      # ------------------------------------------
      # 3. Deploy al VPS
      # ------------------------------------------
      - name: ðŸš€ Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸ“‚ Navegando al directorio del proyecto..."
            cd ${{ env.PROJECT_PATH }}
            
            echo "ðŸ“¥ Obteniendo Ãºltimos cambios de Git..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ³ Reconstruyendo contenedores Docker..."
            docker-compose down
            docker-compose up -d --build
            
            echo "â³ Esperando a que la base de datos estÃ© lista..."
            sleep 10
            
            echo "ðŸ”„ Sincronizando esquema de base de datos..."
            docker-compose exec -T app npx prisma@5.22.0 db push --skip-generate
            
            echo "ðŸ§¹ Limpiando imÃ¡genes Docker no utilizadas..."
            docker image prune -f
            
            echo "âœ… Deploy completado exitosamente!"
          ENDSSH

      # ------------------------------------------
      # 4. Verificar deploy
      # ------------------------------------------
      - name: âœ… Verify Deployment
        run: |
          sleep 15
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            echo "ðŸ” Verificando estado de los contenedores..."
            docker-compose -f ${{ env.PROJECT_PATH }}/docker-compose.yml ps
            
            echo "ðŸ“Š Logs recientes de la aplicaciÃ³n:"
            docker-compose -f ${{ env.PROJECT_PATH }}/docker-compose.yml logs --tail=20 app
          ENDSSH

      # ------------------------------------------
      # 5. NotificaciÃ³n de Ã©xito
      # ------------------------------------------
      - name: ðŸ“¢ Deployment Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment a producciÃ³n completado!"
          echo "ðŸŒ URL: https://limone.usev.app"

      # ------------------------------------------
      # 6. NotificaciÃ³n de fallo
      # ------------------------------------------
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âš ï¸ El deployment ha fallado. Revisa los logs anteriores."
