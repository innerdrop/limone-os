# ============================================================
# ðŸš€ Limone OS - CI/CD Pipeline
# V Solutions | Deploy automÃ¡tico al VPS
# ============================================================

name: Deploy to VPS

on:
  push:
    branches:
      - main
  # Permite ejecuciÃ³n manual desde GitHub
  workflow_dispatch:

env:
  PROJECT_PATH: /var/www/limone

jobs:
  # ============================================
  # Job: Deploy to Production VPS
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      # ------------------------------------------
      # 1. Checkout del cÃ³digo
      # ------------------------------------------
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------
      # 2. Configurar SSH
      # ------------------------------------------
      - name: ðŸ” Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ Error: SSH_PRIVATE_KEY secret is empty"
            exit 1
          fi
          mkdir -p ~/.ssh
          # Limpiar caracteres \r (CR) que suelen venir al copiar desde Windows y asegurar formato
          printf "%s" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

      # ------------------------------------------
      # 3. Deploy al VPS
      # ------------------------------------------
      - name: ðŸš€ Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸ“‚ Navegando al directorio del proyecto..."
            cd ${{ env.PROJECT_PATH }}
            
            echo "ðŸ“¥ Obteniendo Ãºltimos cambios de Git..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ³ Limpiando y reconstruyendo contenedores Docker..."
            # Forzamos la bajada y quita de huÃ©rfanos
            docker-compose down --remove-orphans
            
            # Borramos explÃ­citamente los contenedores para evitar el error de sha256
            docker rm -f limone-app limone-db || true
            
            # Construimos y levantamos desde cero
            docker-compose up -d --build --force-recreate
            
            echo "â³ Esperando a que la base de datos estÃ© lista..."
            sleep 15
            
            echo "ðŸ”„ Sincronizando esquema de base de datos..."
            # Forzamos la versiÃ³n 5.22.0 que es la que usa el proyecto para evitar errores de Prisma 7
            docker-compose exec -T -e DATABASE_URL="postgresql://limone:limone_dev_2025@db:5432/limone?schema=public" app npx prisma@5.22.0 db push --skip-generate --accept-data-loss
            
            echo "ðŸ§¹ Limpiando imÃ¡genes Docker no utilizadas..."
            docker image prune -f
            
            echo "âœ… Deploy completado exitosamente!"
          ENDSSH

      # ------------------------------------------
      # 4. Configurar Nginx (Aumentar lÃ­mite de subida - SIN DUPLICADOS)
      # ------------------------------------------
      - name: ðŸŒ Configure Nginx Limits
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            echo "ðŸ”§ Ajustando lÃ­mites de subida en Nginx (Limpiando duplicados)..."
            # Borramos cualquier lÃ­nea existente para evitar duplicados
            sudo sed -i '/client_max_body_size/d' /etc/nginx/sites-available/limone.usev.app
            # Agregamos la configuraciÃ³n despuÃ©s del server_name
            sudo sed -i '/server_name limone.usev.app;/a \    client_max_body_size 20M;' /etc/nginx/sites-available/limone.usev.app
            
            sudo nginx -t && sudo systemctl reload nginx || echo "âš ï¸ No se pudo recargar Nginx automÃ¡ticamente."
          ENDSSH

      # ------------------------------------------
      # 5. Verificar deploy
      # ------------------------------------------
      - name: âœ… Verify Deployment
        run: |
          sleep 15
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            echo "ðŸ” Verificando estado de los contenedores..."
            docker-compose -f ${{ env.PROJECT_PATH }}/docker-compose.yml ps
            
            echo "ðŸ“Š Logs recientes de la aplicaciÃ³n:"
            docker-compose -f ${{ env.PROJECT_PATH }}/docker-compose.yml logs --tail=20 app
          ENDSSH

      # ------------------------------------------
      # 5. NotificaciÃ³n de Ã©xito
      # ------------------------------------------
      - name: ðŸ“¢ Deployment Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment a producciÃ³n completado!"
          echo "ðŸŒ URL: https://limone.usev.app"

      # ------------------------------------------
      # 6. NotificaciÃ³n de fallo
      # ------------------------------------------
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âš ï¸ El deployment ha fallado. Revisa los logs anteriores."
